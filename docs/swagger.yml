openapi: 3.0.0
info:
  title: Unified Payment Orchestration Platform API
  description: |-
    API specifications based on the comprehensive Database Design.
    Focuses on Payment Intents, User Management, Core Banking, and Compliance.
  version: 2.0.0
servers:
  - url: http://localhost:3000
    description: API Gateway
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    # --- Users & Auth ---
    User:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        username:
          type: string
        email:
          type: string
          format: email
        phone_number:
          type: string
          description: "International format (e.g. +1234567890)"
        role:
          type: string
        is_active:
          type: boolean
        risk_profile:
          type: string
        created_at:
          type: string
          format: date-time
    RegisterRequest:
      type: object
      required: [username, email, password]
      properties:
        username:
          type: string
        email:
          type: string
        phone_number:
          type: string
          description: "Optional"
        password:
          type: string
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string
    AuthResponse:
      type: object
      properties:
        token:
          type: string
        user:
          $ref: '#/components/schemas/User'

    # --- Payment Methods ---
    PaymentMethod:
      type: object
      properties:
        method_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        type:
          type: string
          enum: [card, bank_account, wallet, crypto]
        details:
          type: object
          description: JSON details (masked)
        is_default:
          type: boolean
        created_at:
          type: string
          format: date-time
    CreatePaymentMethodRequest:
      type: object
      required: [type, details]
      properties:
        type:
          type: string
        details:
          type: object
        is_default:
          type: boolean

    # --- Accounts (Core Banking) ---
    Account:
      type: object
      properties:
        account_id:
          type: string
          format: uuid
        user_id:
          type: string
        account_type:
          type: string
        currency:
          type: string
        status:
          type: string
        balance:
          type: number
          description: Derived from latest snapshot or ledger
    CreateAccountRequest:
      type: object
      required: [user_id, account_type, currency]
      properties:
        user_id:
          type: string
        account_type:
          type: string
        currency:
          type: string

    # --- Payment Intents (Orchestration) ---
    PaymentIntent:
      type: object
      properties:
        intent_id:
          type: string
          format: uuid
        user_id:
          type: string
        amount:
          type: number
        currency:
          type: string
        status:
          type: string
          enum: [created, processing, requires_action, succeeded, failed]
        metadata:
          type: object
        created_at:
          type: string
          format: date-time
    CreatePaymentIntentRequest:
      type: object
      required: [amount, currency, user_id]
      properties:
        amount:
          type: number
        currency:
          type: string
        user_id:
          type: string
        payment_method_id:
          type: string
          description: Optional. If not provided, user must confirm later.
        metadata:
          type: object

    # --- Transactions & Ledger ---
    Transaction:
      type: object
      properties:
        transaction_id:
          type: string
          format: uuid
        intent_id:
          type: string
        transaction_type:
          type: string
        amount:
          type: number
        currency:
          type: string
        status:
          type: string
        from_account_id:
          type: string
        to_account_id:
          type: string
        created_at:
          type: string
          format: date-time

    # --- Compliance ---
    FraudRule:
      type: object
      properties:
        rule_id:
          type: string
          format: uuid
        rule_name:
          type: string
        threshold:
          type: number
        is_active:
        is_active:
          type: boolean

    # --- Transaction Requests ---
    TransferRequest:
      type: object
      required: [from_account_id, to_account_id, amount, currency, idempotency_key]
      properties:
        idempotency_key:
          type: string
        from_account_id:
          type: string
          format: uuid
        to_account_id:
          type: string
          format: uuid
        amount:
          type: number
        currency:
          type: string
        description:
          type: string
    DepositRequest:
      type: object
      required: [account_id, amount, currency, idempotency_key]
      properties:
        idempotency_key:
          type: string
        account_id:
          type: string
          format: uuid
        amount:
          type: number
        currency:
          type: string
        provider:
          type: string
        provider_transaction_id:
          type: string
    WithdrawalRequest:
      type: object
      required: [account_id, amount, currency, idempotency_key]
      properties:
        idempotency_key:
          type: string
        account_id:
          type: string
          format: uuid
        amount:
          type: number
        currency:
          type: string

paths:
  # --- Auth & Users ---
  /auth/register:
    post:
      tags: [Auth]
      summary: Register User
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        201:
          description: Created
  /auth/login:
    post:
      tags: [Auth]
      summary: Login
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /users/{user_id}/payment-methods:
    get:
      tags: [Payment Methods]
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: List methods
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PaymentMethod'
    post:
      tags: [Payment Methods]
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentMethodRequest'
      responses:
        201:
          description: Method added

  # --- Payment Orchestration ---
  /payment-intents:
    post:
      tags: [Payment Orchestration]
      summary: Create Payment Intent
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentIntentRequest'
      responses:
        201:
          description: Intent created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentIntent'
  /payment-intents/{intent_id}:
    get:
      tags: [Payment Orchestration]
      security:
        - bearerAuth: []
      parameters:
        - name: intent_id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: Intent details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentIntent'
  /payment-intents/{intent_id}/confirm:
    post:
      tags: [Payment Orchestration]
      summary: Confirm and execute payment
      security:
        - bearerAuth: []
      parameters:
        - name: intent_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                payment_method_id:
                  type: string
      responses:
        200:
          description: Payment processing/succeeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentIntent'

  # --- Core Banking ---
  /core/accounts:
    post:
      tags: [Core Banking]
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAccountRequest'
      responses:
        201:
          description: Account created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
  /core/accounts/{account_id}:
    get:
      tags: [Core Banking]
      security:
        - bearerAuth: []
      parameters:
        - name: account_id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: Account details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
  /core/accounts/{account_id}/transactions:
    get:
      tags: [Core Banking]
      security:
        - bearerAuth: []
      parameters:
        - name: account_id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: Transaction history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Transaction'

  # --- Compliance ---
  /compliance/fraud-rules:
    get:
      tags: [Compliance]
      security:
        - bearerAuth: []
      responses:
        200:
          description: List rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FraudRule'



  /core/transactions/transfer:
    post:
      tags: [Core Banking]
      summary: Transfer Funds
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransferRequest'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
  /core/transactions/deposit:
    post:
      tags: [Core Banking]
      summary: Deposit Funds
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DepositRequest'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
  /core/transactions/withdrawal:
    post:
      tags: [Core Banking]
      summary: Withdraw Funds
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WithdrawalRequest'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'